<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>N05-24 Railway Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; }
        #map { width: 100%; height: 100%; }
        .layer-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 14px;
            border-radius: 8px;
            font-family: 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            min-width: 220px;
        }
        .layer-toggle label { display: block; margin-bottom: 6px; font-size: 14px; }
        .layer-toggle input[type="checkbox"] { margin-right: 6px; }
        .date-filter { margin-top: 8px; display: flex; flex-direction: column; gap: 6px; }
        .date-filter label { font-weight: bold; font-size: 13px; }
        .date-filter-controls { display: flex; gap: 6px; align-items: center; }
        .date-filter-controls input[type="date"] { flex: 1 1 auto; padding: 4px 6px; font-size: 13px; }
        .date-filter-controls button { padding: 4px 8px; font-size: 12px; cursor: pointer; }
        .status { margin-top: 6px; font-size: 12px; color: #333; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="layer-toggle">
        <label><input type="checkbox" id="railroadsToggle" checked> 鉄道路線</label>
        <label><input type="checkbox" id="stationsToggle" checked> 駅</label>
        <div class="date-filter">
            <label for="dateFilter">対象日</label>
            <div class="date-filter-controls">
                <input type="date" id="dateFilter" aria-label="対象日">
                <button type="button" id="clearDate">クリア</button>
            </div>
        </div>
        <div id="filterStatus" class="status">全期間を表示中</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    if (!window.L) {
        alert('Leaflet の読み込みに失敗しました。ネットワークと CDN アクセスを確認してください。');
    }

    const map = L.map('map').setView([35.6812, 139.7671], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://openstreetmap.org/" target="_blank" rel="noopener">OpenStreetMap</a> contributors'
    }).addTo(map);

    const layerStyle = {
        railroads: {
            color: '#cc0000',
            weight: 2,
            opacity: 0.8
        },
        stations: {
            radius: 4,
            fillColor: '#0044cc',
            color: '#ffffff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9
        }
    };

    const railroadsLayer = L.geoJSON(null, {
        style: layerStyle.railroads,
        onEachFeature(feature, layer) {
            const name = feature.properties && (feature.properties.N05_004 || feature.properties.N05_002);
            if (name) {
                layer.bindPopup(`路線名: ${name}`);
            }
        }
    });

    const stationsLayer = L.geoJSON(null, {
        pointToLayer(feature, latlng) {
            return L.circleMarker(latlng, layerStyle.stations);
        },
        onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.N05_011) {
                layer.bindPopup(`駅名: ${feature.properties.N05_011}`);
            }
        }
    });

    const railroadsToggle = document.getElementById('railroadsToggle');
    const stationsToggle = document.getElementById('stationsToggle');
    const dateInput = document.getElementById('dateFilter');
    const clearButton = document.getElementById('clearDate');
    const statusEl = document.getElementById('filterStatus');

    railroadsToggle.addEventListener('change', () => toggleLayer(railroadsToggle, railroadsLayer));
    stationsToggle.addEventListener('change', () => toggleLayer(stationsToggle, stationsLayer));

    let lastRequestId = 0;

    async function loadData(dateString) {
        const requestId = ++lastRequestId;
        statusEl.textContent = '読み込み中…';

        try {
            const [railroads, stations] = await Promise.all([
                fetchDataset('/api/railroads', dateString),
                fetchDataset('/api/stations', dateString)
            ]);

            if (requestId !== lastRequestId) {
                return; // Outdated request; do not update layers.
            }

            applyCollection(railroadsLayer, railroads.data, railroadsToggle);
            applyCollection(stationsLayer, stations.data, stationsToggle);

            updateStatus(dateString, railroads.count, stations.count);
            fitToLayers();
        } catch (err) {
            console.error('データの読み込みに失敗しました', err);
            if (requestId === lastRequestId) {
                statusEl.textContent = 'データ取得に失敗しました。';
                alert('データの読み込みに失敗しました。サーバーログを確認してください。');
            }
        }
    }

    async function fetchDataset(path, dateString) {
        const query = dateString ? `?date=${encodeURIComponent(dateString)}` : '';
        const response = await fetch(`${path}${query}`);
        if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status}: ${text}`);
        }
        const data = await response.json();
        const countHeader = response.headers.get('X-Feature-Count');
        const parsed = Number.parseInt(countHeader ?? '', 10);
        const count = Number.isNaN(parsed) ? 0 : parsed;
        return { data, count };
    }

    function applyCollection(layer, collection, toggle) {
        layer.clearLayers();
        if (collection) {
            layer.addData(collection);
        }

        if (toggle.checked) {
            layer.addTo(map);
        } else {
            map.removeLayer(layer);
        }
    }

    function toggleLayer(toggle, layer) {
        if (toggle.checked) {
            layer.addTo(map);
        } else {
            map.removeLayer(layer);
        }
        fitToLayers();
    }

    function fitToLayers() {
        const group = L.featureGroup([]);
        if (map.hasLayer(railroadsLayer)) {
            group.addLayer(railroadsLayer);
        }
        if (map.hasLayer(stationsLayer)) {
            group.addLayer(stationsLayer);
        }
        if (group.getLayers().length > 0 && group.getBounds().isValid()) {
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }

    function updateStatus(dateString, railCount, stationCount) {
        if (!dateString) {
            statusEl.textContent = `全期間を表示中（路線 ${railCount} 件 / 駅 ${stationCount} 件）`;
            return;
        }
        statusEl.textContent = `${dateString} 時点（路線 ${railCount} 件 / 駅 ${stationCount} 件）`;
    }

    dateInput.addEventListener('change', () => {
        const value = dateInput.value;
        loadData(value);
    });

    clearButton.addEventListener('click', () => {
        if (dateInput.value === '') {
            return;
        }
        dateInput.value = '';
        loadData('');
    });

    // 初期ロード
    loadData('');
    </script>
</body>
</html>
